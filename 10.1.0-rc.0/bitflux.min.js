!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("d3"),require("d3fc"),require("jquery")):"function"==typeof define&&define.amd?define(["d3","d3fc","jquery"],b):a.bitflux=b(a.d3,a.fc,a.$)}(this,function(a,b,c){"use strict";function d(c,d,e){var f=b.util.extent().fields("date")(d),g=c.map(function(a){return a.getTime()}),h=(a.max(g)-a.min(g))/1e3;if(e.getTime()<f[0]||e.getTime()>f[1])return[new Date(a.min(g)),new Date(a.max(g))];var i=[a.time.second.offset(e,-h/2),a.time.second.offset(e,h/2)],j=0;return i[1].getTime()>f[1].getTime()?j=(f[1].getTime()-i[1].getTime())/1e3:i[0].getTime()<f[0].getTime()&&(j=(f[0].getTime()-i[0].getTime())/1e3),[a.time.second.offset(i[0],j),a.time.second.offset(i[1],j)]}function e(b,c){var d=a.min(b,function(a){return a.getTime()}),e=a.max(b,function(a){return a.getTime()}),f=c.sort(function(a,b){return a.date-b.date}),g=a.bisector(function(a){return a.date}),h=c.slice(
// Pad and clamp the bisector values to ensure extents can be calculated
Math.max(0,g.left(f,d)-1),Math.min(g.right(f,e)+1,f.length));return h}function f(c,d,e){arguments.length<3&&(e=1);var f=b.util.extent().fields("date")(d),g=(f[1].getTime()-f[0].getTime())/1e3,h=c.map(function(a){return a.getTime()}),i=e*(a.max(h)-a.min(h))/1e3,j=g>i?[a.time.second.offset(f[1],-i),f[1]]:f;return j}function g(b,c){var d=a.max(b,function(a){return a.getTime()}),e=a.max(c,function(a){return a.date.getTime()});return d===e}function h(a,c){function d(b){return a.secondaries.filter(function(a,c){return c===b})}for(var e=0,f=0;f<c.secondaries.length;f++)c.secondaries[f]&&e++;a.secondaries.filter(function(a,b){return e>b}).style("flex","1"),a.secondaries.filter(function(a,b){return b>=e}).style("flex","0"),a.overlaySecondaries.filter(function(a,b){return e>b}).style("flex","1"),a.overlaySecondaries.filter(function(a,b){return b>=e}).style("flex","0");var g=parseInt(a.app.select(".head-row").style("height"),10);na||(g+=parseInt(a.app.select(".head-row").style("padding-top"),10)+parseInt(a.app.select(".head-row").style("padding-bottom"),10)+parseInt(a.app.select(".head-row").style("margin-bottom"),10),na=!0);var h=b.util.innerDimensions(a.app.node()).height-g;a.chartsAndOverlay.style("height",h+"px"),c.xAxis.dimensionChanged(a.xAxis),c.navbar.dimensionChanged(a.navbar),c.primary.dimensionChanged(a.primary);for(var i=0;i<c.secondaries.length;i++)c.secondaries[i].option.dimensionChanged(d(i))}function i(){return++oa}function j(a){return c(a).width()}
// Inspired by underscore library implementation of debounce
function k(a,b,c){var d,e,f,g,h=function(){var i=(new Date).getTime()-f;b>i&&i>=0?d=setTimeout(h.bind(this),b-i):(d=null,c||(g=a.apply(this,e),e=null))};return function(){e=arguments,f=(new Date).getTime();var i=c&&!d;return d||(d=setTimeout(h.bind(this),b)),i&&(g=a.apply(this,e),e=null),g}}
// Inspired by underscore library implementation of throttle
function l(a,b,c){var d,e,f=null,g=0;c||(c={});var h=function(){g=c.leading===!1?0:(new Date).getTime(),f=null,e=a.apply(this,d),f||(d=null)};return function(){var i=(new Date).getTime();g||c.leading!==!1||(g=i);var j=b-(i-g);return d=arguments,0>=j||j>b?(f&&(clearTimeout(f),f=null),g=i,e=a.apply(this,d),f||(d=null)):f||c.trailing===!1||(f=setTimeout(h.bind(this),j)),e}}function m(c){function d(a){
// Don't pan off sides
// Don't pan off sides
return a[0]>=0?-a[0]:a[1]<=0?-a[1]:0}function e(a){
// If zooming, and about to pan off screen, do nothing
return a[0]>0&&a[1]<0}function f(a){var b=k.translate()[0];b+=a,k.translate([b,0])}function g(){k.translate([0,0]),k.scale(1)}function h(a){var h=b.util.extent().fields("date")(a.datum().data);k.x(i).on("zoom",function(){var b=i(h[0]),o=i(h[1]),p=e([b,o-c]),q=d([b,o-c]);f(q);var r=1===k.scale(),s=1!==k.scale();if(r&&l||s&&m){var t=i.domain();p?t=h:s&&n&&(t=pa.domain.moveToLatest(t,a.datum().data)),t[0].getTime()!==t[1].getTime()?j.zoom(t):
// Ensure the user can't zoom-in infinitely, causing the chart to fail to render
// #168, #411
g()}else g()}),a.call(k)}var i,j=a.dispatch("zoom"),k=a.behavior.zoom(),l=!0,m=!0,n=!0;return h.allowPan=function(a){return arguments.length?(l=a,h):l},h.allowZoom=function(a){return arguments.length?(m=a,h):m},h.trackingLatest=function(a){return arguments.length?(n=a,h):n},h.scale=function(a){return arguments.length?(i=a,h):i},a.rebind(h,j,"on"),h}function n(){function c(b){b.each(function(c){var g=a.select(this).call(k),i=m(d).scale(f).trackingLatest(h).on("zoom",function(a){e[qa.viewChange](a)});g.select(".plot-area-container").datum({data:b.datum()}).call(i)})}var d,e=a.dispatch(qa.viewChange),f=b.scale.dateTime(),g=a.scale.linear(),h=!0,i=60,j=b.series.multi(),k=b.chart.cartesian(f,g).plotArea(j).xTicks(0).yOrient("right").margin({top:0,left:0,bottom:0,right:i});return c.trackingLatest=function(a){return arguments.length?(h=a,c):h},a.rebind(c,e,"on"),a.rebind(c,j,"series","mapping","decorate"),a.rebind(c,k,"yTickValues","yTickFormat","yTicks","xDomain","yDomain"),c.dimensionChanged=function(a){d=pa.width(a.node())-i},c}function o(){function c(a){var c=a.datum();g(c.data);var d=b.util.extent().fields("macd").symmetricalAbout(0).pad(.08)(c.data.map(function(a){return a.macd}));h.trackingLatest(c.trackingLatest).xDomain(c.viewDomain).yDomain(d),a.datum(c.data).call(h)}var d=a.dispatch(qa.viewChange),e=b.annotation.line().value(0).label(""),f=b.indicator.renderer.macd(),g=b.indicator.algorithm.macd(),h=n().series([e,f]).yTicks(5).mapping(function(a){return a===e?[0]:this}).decorate(function(a){a.enter().attr("class",function(a,b){return["multi zero","multi"][b]})}).on(qa.viewChange,function(a){d[qa.viewChange](a)});return a.rebind(c,d,"on"),c.dimensionChanged=function(a){h.dimensionChanged(a)},c}function p(){function c(a){var b=a.datum();f(b.data),h.trackingLatest(b.trackingLatest).xDomain(b.viewDomain).yDomain([0,100]),a.datum(b.data).call(h)}var d=a.dispatch(qa.viewChange),e=b.indicator.renderer.relativeStrengthIndex(),f=b.indicator.algorithm.relativeStrengthIndex(),g=[e.lowerValue(),50,e.upperValue()],h=n().series([e]).yTickValues(g).on(qa.viewChange,function(a){d[qa.viewChange](a)});return a.rebind(c,d,"on"),c.dimensionChanged=function(a){h.dimensionChanged(a)},c}function q(){function c(a){a.each(function(c){var d=b.util.extent().fields("volume").pad(.08)(c.data);d[0]<0&&(d[0]=0),f.yTickFormat(c.product.volumeFormat).trackingLatest(c.trackingLatest).xDomain(c.viewDomain).yDomain(d),a.datum(c.data).call(f)})}var d=a.dispatch(qa.viewChange),e=b.series.bar().xValue(function(a){return a.date}).yValue(function(a){return a.volume}),f=n().series([e]).yTicks(4).on(qa.viewChange,function(a){d[qa.viewChange](a)});return a.rebind(c,d,"on"),c.dimensionChanged=function(a){f.dimensionChanged(a)},c}function r(){function c(a,b){a.select(".plot-area").selectAll(".e, .w").classed("hidden",b)}function d(a){return a.extent()[0][0]-a.extent()[1][0]===0}function e(a,c){var d=a.selectAll("defs").data([0]).enter().append("defs");d.html('<linearGradient id="brush-gradient" x1="0" x2="0" y1="0" y2="1">               <stop offset="0%" class="brush-gradient-top" />               <stop offset="100%" class="brush-gradient-bottom" />           </linearGradient>           <mask id="brush-mask">               <rect class="mask-background"></rect>           </mask>'),a.select(".mask-background").attr({width:g,height:j}),z.domain(b.util.extent().fields("date")(c)),A.domain(b.util.extent().fields(["low","high"]).pad(r)(c)),a.select("mask").datum(c).call(B)}function f(a){var f=a.datum();e(a,f.data),u.domain(f.viewDomain);var h=pa.domain.filterDataInDateRange(b.util.extent().fields("date")(f.data),f.data),i=b.util.extent().fields(["low","high"]).pad(r)(h);t.xDomain(b.util.extent().fields("date")(f.data)).yDomain(i),x.on("brush",function(){var b=d(x);
// Hide the bar if the extent is empty
c(a,b),b||s[qa.viewChange]([x.extent()[0][0],x.extent()[1][0]])}).on("brushend",function(){var b=d(x);c(a,!1),b&&s[qa.viewChange](pa.domain.centerOnDate(u.domain(),f.data,x.extent()[0][0]))}),t.plotArea(y),a.call(t);
// Allow to zoom using mouse, but disable panning
var j=m(g).scale(u).trackingLatest(f.trackingLatest).allowPan(!1).on("zoom",function(a){s[qa.viewChange](a)});a.select(".plot-area").call(j)}var g,h=100,i=40,j=h-i,k=2,l=k/2,n=j-l,o=n,p=l+o/2,q=2,r=[0,.04],s=a.dispatch(qa.viewChange),t=b.chart.cartesian(b.scale.dateTime(),a.scale.linear()).yTicks(0).margin({bottom:i}),u=b.scale.dateTime(),v=b.series.area().xValue(function(a){return a.date}).yValue(function(a){return a.close}),w=b.series.line().xValue(function(a){return a.date}).yValue(function(a){return a.close}),x=a.svg.brush(),y=b.series.multi().series([v,w,x]).decorate(function(a){var b=a.enter();a.select(".extent").attr("height",n).attr("y",k/2),
// overload d3 styling for the brush handles
// as Firefox does not react properly to setting these through less file.
b.selectAll(".resize.w>rect, .resize.e>rect").attr("width",q).attr("x",-q/2),a.selectAll(".resize.w>rect, .resize.e>rect").attr("height",o).attr("y",l),b.select(".extent").attr("mask",'url("#brush-mask")').attr("fill",'url("#brush-gradient")');
// Adds the handles to the brush sides
var c=b.selectAll(".e, .w");c.append("circle").attr("cy",p).attr("r",7).attr("class","outer-handle"),c.append("circle").attr("cy",p).attr("r",4).attr("class","inner-handle")}).mapping(function(a){return a!==x?this.data:void x.extent([[u.domain()[0],t.yDomain()[0]],[u.domain()[1],t.yDomain()[1]]])}),z=b.scale.dateTime(),A=a.scale.linear(),B=b.series.area().xValue(function(a){return a.date}).yValue(function(a){return a.close}).xScale(z).yScale(A);return a.rebind(f,s,"on"),f.dimensionChanged=function(a){g=pa.width(a.node()),u.range([0,g]),z.range([0,g]),A.range([j,0])},f}function s(){function c(b){b.each(function(b){var c=a.select(this),h=c.select("#tooltip");d=b.product.priceFormat,e=b.product.volumeFormat,f=b.period.timeFormat,c.classed("hidden",!b.data),h.layout({flexDirection:"row"}).selectAll(".tooltip").layout({marginRight:40,marginLeft:15}),b.data&&h.datum(b.data).call(g)})}var d,e,f,g=b.chart.tooltip().items([["T",function(a){return f(a.date)}],["O",function(a){return d(a.open)}],["H",function(a){return d(a.high)}],["L",function(a){return d(a.low)}],["C",function(a){return d(a.close)}],["V",function(a){return e(a.volume)}]]);return c}function t(){function c(a){var b=(e.ticks()[1]-e.ticks()[0])/1e3;b<a.seconds?f.ticks(a.d3TimeInterval.unit,a.d3TimeInterval.value):f.ticks(6)}function d(a){var b=a.datum();e.domain(b.viewDomain),c(b.period),a.call(f)}var e=b.scale.dateTime(),f=a.svg.axis().scale(e).orient("bottom");return d.dimensionChanged=function(a){e.range([0,pa.width(a.node())])},d}function u(a,b,c,d,e){return{displayString:a,// TODO: is 'displayName' better?
valueString:b,// TODO: is this an id?
option:c,// TODO: Ideally, remove.
isSelected:!1,icon:d,isPrimary:e}}function v(){var c=b.scale.dateTime(),d=a.scale.linear(),e=b.util.fractionalBarWidth(.75),f=function(a,b){return a.date},g=function(a,b){return c(f(a,b))},h=function(a){return a.low},i=function(a){return a.high},j=function(a,b){return a.close},k=b.svg.candlestick().x(function(a){return c(a.date)}).open(function(a){return d(a.open)}).high(function(a){return d(i(a))}).low(function(a){return d(h(a))}).close(function(a){return d(a.close)}),l=b.util.dataJoin().selector("path.up").element("path").attr("class","up"),m=b.util.dataJoin().selector("path.down").element("path").attr("class","down"),n=function(a){a.each(function(a){k.width(e(a.map(g)));var b=a.filter(function(a){return a.open<a.close}),c=a.filter(function(a){return a.open>=a.close});l(this,[b]).attr("d",k),m(this,[c]).attr("d",k)})};return n.xScale=function(a){return arguments.length?(c=a,n):c},n.yScale=function(a){return arguments.length?(d=a,n):d},n.xValue=function(a){return arguments.length?(f=a,n):f},n.yLowValue=function(a){return arguments.length?(h=a,n):h},n.yHighValue=function(a){return arguments.length?(i=a,n):i},n.yCloseValue=function(a){return arguments.length?(j=a,n):j},n.width=function(a){return e(a.map(g))},n}function w(a,b){var c=b/2;return[[0,0],[c,-c],[a,-c],[a,c],[c,c],[0,0]]}function x(a,b){for(var c=a.ticks.apply(a,[]),d=a.domain(),e=0;e<b.length;e++)b[e]>d[0]&&b[e]<d[1]&&c.push(b[e]);return c}function y(a){return a.reduce(function(a,b){return b.extentAccessor?a.concat(b.extentAccessor):a},[])}function z(){function c(){var a=[s,j.option,t],b=p.map(function(a){return a.option});return a.concat(b,r)}function d(){switch(B.value(o),C.value(o),t.value(o),j.valueString){case"line":case"point":case"area":j.option.yValue(o)}}
// Call when what to display on the chart is modified (ie series, options)
function e(a){j=a.series,o=a.yValueAccessor.option,p=a.indicators,d(),u.series(c()),A.yTickFormat(a.product.priceFormat),a.selectorsChanged=!1}function f(a){var b=j.option.width(a);r.decorate(function(a){a.classed("band",!0),a.selectAll(".vertical > line").style("stroke-width",b)})}function g(a){a.classed("band",!1).selectAll("line").style("stroke-width",null)}function h(a){"candlestick"===j.valueString||"ohlc"===j.valueString?f(a):r.decorate(g)}function i(c){var d=c.datum();d.selectorsChanged&&e(d),A.xDomain(d.viewDomain),r.snap(b.util.seriesPointSnapXOnly(j.option,d.data)),h(d.data),B(d.data),C(d.data);
// Scale y axis
var f=pa.domain.filterDataInDateRange(A.xDomain(),d.data),g=y(u.series()),i=b.util.extent().fields(g).pad(.08)(f);A.yDomain(i);
// Find current tick values and add close price to this list, then set it explicitly below
var p=o(d.data[d.data.length-1]),q=x(z,[p]);A.yTickValues(q).yDecorate(function(b){var c=b.selectAll(".tick").filter(function(a){return a===p}).classed("close-line",!0),d=18;c.select("path").attr("d",function(b){return a.svg.area()(w(l,d))}),c.select("text").attr("transform","translate("+d/2+",1)")}),s.yTicks(q.length-1),
// Redraw
A.plotArea(u),c.call(A);var t=m(k).scale(v).trackingLatest(d.trackingLatest).on("zoom",function(a){n[qa.viewChange](a)});c.select(".plot-area").call(t)}var j,k,l=60,n=a.dispatch(qa.viewChange,qa.crosshairChange),o=function(a){return a.close},p=[],q=[],r=b.tool.crosshair().xLabel("").yLabel("").on("trackingmove",function(a){a.length>0?n.crosshairChange(a[0].datum):n.crosshairChange(void 0)}).on("trackingend",function(){n.crosshairChange(void 0)});r.id=pa.uid();var s=b.annotation.gridline().xTicks(0),t=b.annotation.line().orient("horizontal").value(o).label("").decorate(function(a){a.classed("close-line",!0)});t.id=pa.uid();var u=b.series.multi().key(function(a){return a.id}).mapping(function(a){switch(a){case t:return[this.data[this.data.length-1]];case r:return q;default:return this.data}}),v=b.scale.dateTime(),z=a.scale.linear(),A=b.chart.cartesian(v,z).xTicks(0).yOrient("right").margin({top:0,left:0,bottom:0,right:l}),B=b.indicator.algorithm.movingAverage(),C=b.indicator.algorithm.bollingerBands();
// Call when the main layout is modified
return a.rebind(i,n,"on"),i.dimensionChanged=function(a){k=pa.width(a.node())-l},i}function A(a){return{displayString:a.display,option:a}}function B(a){return{displayString:a.display,option:a}}function C(){function c(a){var b=a.datum(),c=b.selectedIndex||0,i=b.config,j=e(a,[b.options]);if(i.icon){var k=j.selectAll(".icon").data([0]);k.enter().append("span"),k.attr("class","icon "+b.options[c].icon)}else j.select(".icon").remove(),j.text(function(){return i.title||b.options[c].displayString});f(j,i.careted?[0]:[]);var l=g(a,[b.options]),m=h(l,b.options),n=m.enter().on("click",d.optionChange).append("a").attr("href","#");n.append("span").attr("class","icon"),n.append("span").attr("class","name"),m.selectAll(".icon").attr("class",function(a){return"icon "+a.icon}),m.selectAll(".name").text(function(a){return a.displayString})}var d=a.dispatch("optionChange"),e=b.util.dataJoin().selector("button").element("button").attr({"class":"dropdown-toggle",type:"button","data-toggle":"dropdown"}),f=b.util.dataJoin().selector(".caret").element("span").attr("class","caret"),g=b.util.dataJoin().selector("ul").element("ul").attr("class","dropdown-menu"),h=b.util.dataJoin().selector("li").element("li").key(function(a){return a.displayString});return a.rebind(c,d,"on"),c}function D(){function c(a){var c=a.datum().selectedIndex||0,f=e(a,[a.datum().options]);f.enter().append("ul");var g=f.selectAll("li").data(b.util.fn.identity);g.enter().append("li").append("a").attr("href","#").on("click",d.tabClick),g.classed("active",function(a,b){return b===c}).select("a").text(function(a){return a.displayString}),g.exit().remove()}var d=a.dispatch("tabClick"),e=b.util.dataJoin().selector("ul").element("ul");return a.rebind(c,d,"on"),c}function E(){var b=a.dispatch(qa.dataProductChange,qa.dataPeriodChange,qa.clearAllPrimaryChartIndicatorsAndSecondaryCharts),c=C().on("optionChange",b[qa.dataProductChange]),d=D().on("tabClick",b[qa.dataPeriodChange]),e=C().on("optionChange",b[qa.dataPeriodChange]),f=function(f){f.each(function(f){var g=a.select(this),h=f.products;g.select("#product-dropdown").datum({config:f.productConfig,options:h.map(A),selectedIndex:h.map(function(a){return a.id}).indexOf(f.selectedProduct.id)}).call(c);var i=f.selectedProduct.periods;g.select("#period-selector").classed("hidden",i.length<=1).datum({options:i.map(B),selectedIndex:i.indexOf(f.selectedPeriod)}).call(d),g.select("#mobile-period-selector").classed("hidden",i.length<=1).datum({config:f.mobilePeriodConfig,options:i.map(B),selectedIndex:i.indexOf(f.selectedPeriod)}).call(e),g.select("#clear-indicators").on("click",b[qa.clearAllPrimaryChartIndicatorsAndSecondaryCharts])})};return a.rebind(f,b,"on"),f}function F(){var b=a.dispatch(qa.primaryChartSeriesChange,qa.primaryChartIndicatorChange,qa.secondaryChartChange),c=C().on("optionChange",b[qa.primaryChartSeriesChange]),d=C().on("optionChange",function(a){a.isPrimary?b[qa.primaryChartIndicatorChange](a):b[qa.secondaryChartChange](a)}),e=function(b){b.each(function(b){var e=a.select(this),f=b.seriesSelector.options.map(function(a){return a.isSelected}).indexOf(!0);e.select(".series-dropdown").datum({config:b.seriesSelector.config,options:b.seriesSelector.options,selectedIndex:f}).call(c);var g=b.indicatorSelector.options,h=g.map(function(a,b){return a.isSelected?b:null}).filter(function(a){return a});e.select(".indicator-dropdown").datum({config:b.indicatorSelector.config,options:g,selected:h}).call(d)})};return a.rebind(e,b,"on"),e}function G(){function b(a){var b=a.datum(),d=a.selectAll("g").data([b]);d.enter().append("g").attr("class","reset-button").on("click",function(){c[qa.resetToLatest]()}).append("path").attr("d","M1.5 1.5h13.438L23 20.218 14.937 38H1.5l9.406-17.782L1.5 1.5z"),d.classed("active",!b.trackingLatest)}var c=a.dispatch(qa.resetToLatest);return a.rebind(b,c,"on"),b}function H(){function b(b){b.each(function(b){var d=a.select(this),e=d.selectAll("div").data(b.selectedIndicators,function(a){return a.valueString}),f=e.enter().append("div").attr("class","edit-indicator");f.append("span").attr("class","icon bf-icon-delete").on("click",c.indicatorChange),f.append("span").attr("class","indicator-label").text(function(a){return a.displayString}),e.exit().remove()})}var c=a.dispatch(qa.indicatorChange);return a.rebind(b,c,"on"),b}function I(){var b=a.dispatch(qa.primaryChartIndicatorChange,qa.secondaryChartChange,qa.dataProductChange),c=H().on(qa.indicatorChange,b[qa.primaryChartIndicatorChange]),d=H().on(qa.indicatorChange,b[qa.secondaryChartChange]),e=C().on("optionChange",b[qa.dataProductChange]),f=function(b){b.each(function(b){var f=a.select(this),g=b.products;f.select("#mobile-product-dropdown").datum({config:b.productConfig,options:g.map(A),selectedIndex:g.map(function(a){return a.id}).indexOf(b.selectedProduct.id)}).call(e),f.select("#overlay-primary-container .edit-indicator-container").datum({selectedIndicators:b.primaryIndicators}).call(c),f.selectAll(".overlay-secondary-container").each(function(c,e){var f=a.select(this),g=b.secondaryIndicators[e]?[b.secondaryIndicators[e]]:[];f.select(".edit-indicator-container").datum({selectedIndicators:g}).call(d)})})};return a.rebind(f,b,"on"),f}function J(){function a(a){var c=++b;return function(d,e){b>c||a(d,e)}}var b=0;return a.invalidateCallback=function(){return b++,a},a}function K(){function b(a){var b=1e3*f;return new Date(Math.floor(a.getTime()/b)*b)}var c=function(a){return a.date},d=function(a){return Number(a.volume)},e=function(a){return Number(a.price)},f=60,g=function(f,g){var h=b(c(g)),i=e(g),j=d(g),k=a.bisector(function(a){return a.date}).left,l=f.filter(function(a){return a.date.getTime()===h.getTime()})[0];l?(l.high=Math.max(i,l.high),l.low=Math.min(i,l.low),l.close=i,l.volume+=j):f.splice(k(f,h),0,{date:h,open:i,high:i,low:i,close:i,volume:j})};return g.granularity=function(a){return arguments.length?(f=a,g):f},g.price=function(a){return arguments.length?(e=a,g):e},g.volume=function(a){return arguments.length?(d=a,g):d},g.date=function(a){return arguments.length?(c=a,g):c},g}function L(){function b(){f&&f.streamingFeed&&f.streamingFeed.close(),k=[],i.invalidateCallback()}function c(a){return a.sort(function(a,b){return a.date-b.date})}function d(){null!=f.streamingFeed&&(f.streamingFeed.on("message",function(a){h(k,a),g[qa.newTrade](k,f)}).on("error",function(a){g[qa.streamingFeedError](a,f)}).on("close",function(a){g[qa.streamingFeedClose](a,f)}),f.streamingFeed())}function e(a,e){b(),2===arguments.length&&(f=e.source,f.historicFeed.product(e.id),null!=f.streamingFeed&&f.streamingFeed.product(e.id));var l=new Date;f.historicFeed.end(l).candles(j).granularity(a),h.granularity(a),f.historicFeed(i(function(a,b){a?g[qa.historicFeedError](a,f):(k=c(b),g[qa.historicDataLoaded](k,f),d())}))}var f,g=a.dispatch(qa.newTrade,qa.historicDataLoaded,qa.historicFeedError,qa.streamingFeedError,qa.streamingFeedClose),h=K().date(function(a){return new Date(a.time)}).volume(function(a){return Number(a.size)}),i=J(),j=200,k=[];return e.candlesOfData=function(a){return arguments.length?(j=a,e):j},a.rebind(e,g,"on"),e}function M(){var c=a.dispatch(qa.notificationClose),d=b.util.dataJoin().selector("div.alert-content").element("div").attr("class","alert-content"),e=b.util.dataJoin().selector("div.alert").element("div").attr({"class":"alert alert-info alert-dismissible",role:"alert"}).key(function(a){return a.id}),f=function(b){b.each(function(b){var f=a.select(this),g=d(f,[b]);g.enter().html('<div class="messages"></div>');var h=e(g.select(".messages"),b.messages),i=h.enter();i.html('<button type="button" class="close" aria-label="Close">                     <span aria-hidden="true">&times;</span>                 </button>                 <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>                 <span class="sr-only">Error:</span>                 <span class="message"></span>'),i.select(".close").on("click",function(a){c[qa.notificationClose](a.id)}),h.select(".message").text(function(a){return a.message})})};return a.rebind(f,c,"on"),f}function N(a){return{id:pa.uid(),message:a}}function O(b,c,d,e){return{display:b||"1 day",seconds:c||86400,d3TimeInterval:d||{unit:a.time.day,value:1},timeFormat:a.time.format(e||"%b %d")}}function P(b,c,d,e,f,g){return{id:b,display:c||"Unspecified Product",priceFormat:a.format(g||".2f"),volumeFormat:a.format(f||".2f"),periods:d||[],source:e}}function Q(a,b,c,d){return{historicFeed:a,historicNotificationFormatter:b,streamingFeed:c,streamingNotificationFormatter:d}}function R(a){var b;if(a.wasClean===!1&&1e3!==a.code&&1006!==a.code){var c=a.reason||"Unkown reason.";b="Disconnected from live stream: "+a.code+" "+c}return b}function S(a){var b;
// The WebSocket's error event doesn't contain much useful information,
// so the close event is used to report errors instead
return"error"===a.type&&a.message?b="Live stream error: "+a.message:"close"===a.type&&(b=R(a)),b}function T(a,b,c,d){return{title:a||null,careted:b||!1,listIcons:c||!1,icon:d||!1}}function U(a,b,c){return{productConfig:T(null,!0),mobilePeriodConfig:T(),products:a,selectedProduct:b,selectedPeriod:c,alertMessages:[]}}function V(a,b){return{primaryIndicators:[],secondaryIndicators:[],productConfig:T(),products:a,selectedProduct:b}}function W(a,b){return{config:a,options:b}}function X(a,b){return{data:void 0,product:a,period:b}}function Y(){return{data:[],viewDomain:[],trackingLatest:!0}}function Z(){return{trackingLatest:!0}}function $(a){var b={data:[],trackingLatest:!0,viewDomain:[],selectorsChanged:!0},c=a;Object.defineProperty(b,"product",{get:function(){return c},set:function(a){c=a,b.selectorsChanged=!0}});var d=v();d.id=pa.uid();var e=u("Candlestick","candlestick",d);e.option.extentAccessor=["high","low"],Object.defineProperty(b,"series",{get:function(){return e},set:function(a){e=a,b.selectorsChanged=!0}});var f={option:function(a){return a.close}};Object.defineProperty(b,"yValueAccessor",{get:function(){return f},set:function(a){f=a,b.selectorsChanged=!0}});var g=[];return Object.defineProperty(b,"indicators",{get:function(){return g},set:function(a){g=a,b.selectorsChanged=!0}}),b}function _(a){return{data:[],viewDomain:[],trackingLatest:!0,product:a}}function aa(a){return{viewDomain:[],period:a}}function ba(){return{messages:[]}}function ca(){var a,c,d,e=b.data.random.financial(),f=[86400],g=null,h=function(b){c.setHours(0,0,0,0);var d=864e5;e.startDate(new Date(c-(a-1)*d));var f=e(a);b(null,f)};return h.candles=function(b){return arguments.length?(a=b,h):a},h.end=function(a){return arguments.length?(c=a,h):c},h.granularity=function(a){if(!arguments.length)return d;if(-1===f.indexOf(a))throw new Error("Granularity of "+a+" is not supported. Random Financial Data Generator only supports daily data.");return d=a,h},h.product=function(a){if(!arguments.length)return h;if("Data Generator"!==a)throw new Error("Random Financial Data Generator does not support products.");return g=a,h},h.apiKey=function(){throw new Error("Not implemented.")},h}function da(){var c,d=1e3,e=b.data.feed.coinbase(),f=k(function(b){var d=a.time.second.offset(e.end(),-c*e.granularity());e.start(d),e(b)},d);return f.candles=function(a){return arguments.length?(c=a,f):c},f.apiKey=function(){throw new Error("Not implemented.")},a.rebind(f,e,"end","granularity","product"),f}function ea(a){var b;return a&&(b=a.message),b}
// https://docs.exchange.coinbase.com/#websocket-feed
function fa(){var b,c="BTC-USD",d=a.dispatch("open","close","error","message"),e="match",f=function(a,f){a=a||"wss://ws-feed.exchange.coinbase.com",f=f||{type:"subscribe",product_id:c},b=new WebSocket(a),b.onopen=function(a){b.send(JSON.stringify(f)),d.open(a)},b.onerror=function(a){d.error(a)},b.onclose=function(a){d.close(a)},b.onmessage=function(a){var b=JSON.parse(a.data);b.type===e?d.message(b):"error"===b.type&&d.error(b)}};return a.rebind(f,d,"on"),f.close=function(){
// Only close the WebSocket if it is opening or open
!b||b.readyState!==WebSocket.CONNECTING&&b.readyState!==WebSocket.OPEN||b.close()},f.messageType=function(a){return arguments.length?(e=a,f):e},f.product=function(a){return arguments.length?(c=a,f):c},f}function ga(){function c(a){var b=i.get(a);return b||(b=a[0].toLowerCase()+a.substr(1)),b}function d(b){var c=a.time.second.offset(g.end(),-f*e);g.start(c).collapse(h.get(e)),g(b)}var e,f,g=b.data.feed.quandl().database("WIKI").columnNameMap(c),h=a.map();h.set(86400,"daily"),h.set(604800,"weekly");
// Map fields for WIKI database, to use all adjusted values
var i=a.map();return i.set("Open","unadjustedOpen"),i.set("High","unadjustedHigh"),i.set("Low","unadjustedLow"),i.set("Close","unadjustedClose"),i.set("Volume","unadjustedVolume"),i.set("Adj. Open","open"),i.set("Adj. High","high"),i.set("Adj. Low","low"),i.set("Adj. Close","close"),i.set("Adj. Volume","volume"),d.candles=function(a){return arguments.length?(f=a,d):f},d.granularity=function(a){if(!arguments.length)return e;if(!h.has(a))throw new Error("Granularity of "+a+" is not supported.");return e=a,d},b.util.rebind(d,g,{end:"end",product:"dataset",apiKey:"apiKey"}),d}function ha(a){var b;return a&&a.quandl_error&&(b=a.quandl_error.message),b}function ia(){function c(){return{week1:za.data.period("Weekly",604800,{unit:a.time.week,value:1},"%b %d"),day1:za.data.period("Daily",86400,{unit:a.time.day,value:1},"%b %d"),hour1:za.data.period("1 Hr",3600,{unit:a.time.hour,value:1},"%b %d %Hh"),minute5:za.data.period("5 Min",300,{unit:a.time.minute,value:5},"%H:%M"),minute1:za.data.period("1 Min",60,{unit:a.time.minute,value:1},"%H:%M")}}function d(){return{generated:za.data.source(ca(),null,null),bitcoin:za.data.source(da(),ea,fa(),S),quandl:za.data.source(ga(),ha,null,null)}}function e(){return{generated:za.data.product("Data Generator","Data Generator",[j.day1],k.generated,".3s"),quandl:za.data.product("GOOG","GOOG",[j.day1,j.week1],k.quandl,".3s")}}function f(){var a=v();a.id=pa.uid();var c=za.menu.option("Candlestick","candlestick",a,"bf-icon-candlestick-series");c.isSelected=!0,c.option.extentAccessor=["high","low"];var d=b.series.ohlc();d.id=pa.uid();var e=za.menu.option("OHLC","ohlc",d,"bf-icon-ohlc-series");e.option.extentAccessor=["high","low"];var f=b.series.line().xValue(function(a){return a.date});f.id=pa.uid();var g=za.menu.option("Line","line",f,"bf-icon-line-series");g.option.extentAccessor="close";var h=b.series.point().xValue(function(a){return a.date});h.id=pa.uid();var i=za.menu.option("Point","point",h,"bf-icon-point-series");i.option.extentAccessor="close";var j=b.series.area().xValue(function(a){return a.date});j.id=pa.uid();var k=za.menu.option("Area","area",j,"bf-icon-area-series");k.option.extentAccessor="close";var l=za.menu.dropdownConfig(null,!1,!0,!0),m=[c,e,g,i,k];return za.menu.selector(l,m)}function g(){var a=sa.secondary,c=b.series.line().decorate(function(a){a.enter().classed("movingAverage",!0)}).xValue(function(a){return a.date}).yValue(function(a){return a.movingAverage});c.id=pa.uid();var d=za.menu.option("Moving Average","movingAverage",c,"bf-icon-moving-average-indicator",!0);d.option.extentAccessor=function(a){return a.movingAverage};var e=b.indicator.renderer.bollingerBands();e.id=pa.uid();var f=za.menu.option("Bollinger Bands","bollinger",e,"bf-icon-bollinger-bands-indicator",!0);f.option.extentAccessor=[function(a){return a.bollingerBands.lower},function(a){return a.bollingerBands.upper}];var g=[d,f,za.menu.option("Relative Strength Index","rsi",a.rsi(),"bf-icon-rsi-indicator",!1),za.menu.option("MACD","macd",a.macd(),"bf-icon-macd-indicator",!1),za.menu.option("Volume","volume",a.volume(),"bf-icon-bar-series",!1)];return g}function h(){var a=za.menu.dropdownConfig("Add Indicator",!1,!0);return za.menu.selector(a,g())}function i(){return{seriesSelector:f(),indicatorSelector:h()}}var j=c(),k=d(),l=e();return{periods:j,sources:k,primaryChart:za.chart.primary(l.generated),secondaryChart:za.chart.secondary(l.generated),selectors:i(),xAxis:za.chart.xAxis(j.day1),nav:za.chart.nav(),navReset:za.chart.navigationReset(),headMenu:za.menu.head([l.generated,l.quandl],l.generated,j.day1),legend:za.chart.legend(l.generated,j.day1),overlay:za.menu.overlay([l.generated,l.quandl],l.generated),notificationMessages:za.notification.messages()}}function ja(b){a.json("https://api.exchange.coinbase.com/products",function(a,c){return a?void b(a):void b(a,c)})}function ka(a,b,c,d){return a.map(function(a){return za.data.product(a.id,a.id,d.get(a.id)||c,b)})}function la(){function c(){W&&(W=!1),Y&&G.suspendLayout(!1),G.primary.datum(Q.primaryChart).call(T.primary),G.legend.datum(Q.legend).call(T.legend),G.secondaries.datum(Q.secondaryChart).filter(function(a,b){return b<T.secondaries.length}).each(function(b,c){a.select(this).attr("class","secondary-container secondary-"+T.secondaries[c].valueString).call(T.secondaries[c].option)}),G.xAxis.datum(Q.xAxis).call(T.xAxis),G.navbar.datum(Q.nav).call(T.navbar),G.app.select("#navbar-reset").datum(Q.navReset).call(J),G.app.select(".head-menu").datum(Q.headMenu).call(I),G.app.selectAll(".selectors").datum(Q.selectors).call(K),G.app.select("#notifications").datum(Q.notificationMessages).call(M),G.overlay.datum(Q.overlay).call(H),Y&&(G.suspendLayout(!0),Y=!1)}function d(){Y=!0,pa.layout(G,T)}function e(){a.select(window).on("resize",function(){d(),X()})}function f(a){Q.notificationMessages.messages.unshift(N(a))}function g(a){var b=[a[0],a[1]];Q.primaryChart.viewDomain=b,Q.secondaryChart.viewDomain=b,Q.xAxis.viewDomain=b,Q.nav.viewDomain=b;var c=pa.domain.trackingLatestData(Q.primaryChart.viewDomain,Q.primaryChart.data);Q.primaryChart.trackingLatest=c,Q.secondaryChart.trackingLatest=c,Q.nav.trackingLatest=c,Q.navReset.trackingLatest=c,X()}function h(a){a.isSelected=!a.isSelected,z(),X()}function i(a){a.isSelected=!a.isSelected,B(),X()}function j(a){Q.legend.data=a,X()}function k(a,b){var c;c=b.streamingNotificationFormatter?b.streamingNotificationFormatter(a):S(a),c&&(f(c),X())}function l(){var a=Q.primaryChart.data,c=b.util.extent().fields("date")(a),d=pa.domain.moveToLatest(c,a,V);g(d)}function m(a,b){var c='<div class="spinner"></div>',d='<div class="content alert alert-info">'+b+"</div>";G.app.select("#loading-status-message").classed("hidden",!(a||b)).html(b?d:c)}function n(a){Q.primaryChart.data=a,Q.secondaryChart.data=a,Q.nav.data=a}function o(a){Q.headMenu.selectedProduct=a,Q.primaryChart.product=a,Q.secondaryChart.product=a,Q.legend.product=a,Q.overlay.selectedProduct=a}function p(a){Q.headMenu.selectedPeriod=a,Q.xAxis.period=a,Q.legend.period=a}function q(a){m(!0),o(a),p(a.periods[0]),R(a.periods[0].seconds,a)}function r(){return sa.primary().on(qa.crosshairChange,j).on(qa.viewChange,g)}function s(){return sa.nav().on(qa.viewChange,g)}function t(){return ta.navigationReset().on(qa.resetToLatest,l)}function u(){return L().on(qa.newTrade,function(a,b){if(n(a),Q.primaryChart.trackingLatest){var c=pa.domain.moveToLatest(Q.primaryChart.viewDomain,Q.primaryChart.data);g(c)}}).on(qa.historicDataLoaded,function(a,b){m(!1),n(a),Q.legend.data=null,l(),d()}).on(qa.historicFeedError,function(a,b){m(!1,"Error loading data. Please make your selection again, or refresh the page.");var c="";try{var d=JSON.parse(a.responseText),e=b.historicNotificationFormatter(d);e&&(c=". "+e)}catch(g){c=""}var h=a.statusText||"Unknown reason.",i="Error getting historic data: "+h+c;f(i),X()}).on(qa.streamingFeedError,k).on(qa.streamingFeedClose,k)}function v(){return ta.head().on(qa.dataProductChange,function(a){q(a.option),X()}).on(qa.dataPeriodChange,function(a){m(!0),p(a.option),R(a.option.seconds),X()}).on(qa.clearAllPrimaryChartIndicatorsAndSecondaryCharts,function(){Q.primaryChart.indicators.forEach(x),T.secondaries.forEach(x),z(),B(),X()})}function w(a,b){b.forEach(function(a){a.isSelected=!1}),a.isSelected=!0}function x(a){a.isSelected=!1}function y(){return ta.selectors().on(qa.primaryChartSeriesChange,function(a){Q.primaryChart.series=a,w(a,Q.selectors.seriesSelector.options),X()}).on(qa.primaryChartIndicatorChange,h).on(qa.secondaryChartChange,i)}function z(){Q.primaryChart.indicators=Q.selectors.indicatorSelector.options.filter(function(a){return a.isSelected&&a.isPrimary}),Q.overlay.primaryIndicators=Q.primaryChart.indicators}function A(){T.secondaries=Q.selectors.indicatorSelector.options.filter(function(a){return a.isSelected&&!a.isPrimary}),
// TODO: This doesn't seem to be a concern of menu.
T.secondaries.forEach(function(a){a.option.on(qa.viewChange,g)}),Q.overlay.secondaryIndicators=T.secondaries}function B(){A(),
// TODO: Remove .remove! (could a secondary chart group component manage this?).
G.secondaries.selectAll("*").remove(),d()}function C(){return ta.overlay().on(qa.primaryChartIndicatorChange,h).on(qa.secondaryChartChange,i).on(qa.dataProductChange,function(a){q(a.option),X()})}function D(a){Q.notificationMessages.messages=Q.notificationMessages.messages.filter(function(b){return b.id!==a}),X()}function E(){return ua.toast().on(qa.notificationClose,D)}function F(b,c){if(b){var d=b.statusText||"Unknown reason.",e="Error retrieving Coinbase products: "+d;Q.notificationMessages.messages.unshift(N(e))}else{var f=[Q.periods.hour1,Q.periods.day1],g=a.map();g.set("BTC-USD",[Q.periods.minute1,Q.periods.minute5,Q.periods.hour1,Q.periods.day1]);var h=ka(c,Q.sources.bitcoin,f,g);Q.headMenu.products=Q.overlay.products=Q.headMenu.products.concat(h)}X()}var G,H,I,J,K,M,O='<div class="container-fluid">         <div id="notifications"></div>         <div id="loading-status-message"></div>         <div class="row head-menu head-row">             <div class="col-md-12 head-sub-row">                 <div id="product-dropdown" class="dropdown product-dropdown"></div>                 <div class="selectors">                     <div class="series-dropdown dropdown selector-dropdown"></div>                     <div class="indicator-dropdown dropdown selector-dropdown"></div>                     <div id="mobile-period-selector" class="dropdown"></div>                 </div>                 <div id="period-selector"></div>                 <span id="clear-indicators" class="icon bf-icon-delete delete-button"></span>             </div>         </div>         <div class="row primary-row">             <div id="charts" class="col-md-12">                 <div id="charts-container">                     <svg id="primary-container"></svg>                     <svg class="secondary-container"></svg>                     <svg class="secondary-container"></svg>                     <svg class="secondary-container"></svg>                     <div class="x-axis-row">                         <svg id="x-axis-container"></svg>                     </div>                     <div id="navbar-row">                         <svg id="navbar-container"></svg>                         <svg id="navbar-reset"></svg>                     </div>                 </div>                 <div id="overlay">                     <div id="overlay-primary-container">                         <div id="overlay-primary-head">                             <div class="selectors">                                 <div id="mobile-product-dropdown" class="dropdown"></div>                                 <div class="series-dropdown dropdown selector-dropdown"></div>                                 <div class="indicator-dropdown dropdown selector-dropdown"></div>                             </div>                             <div id="legend">                                 <svg id="tooltip"></svg>                             </div>                         </div>                         <div id="overlay-primary-bottom">                             <div class="edit-indicator-container"></div>                         </div>                     </div>                     <div class="overlay-secondary-container">                         <div class="edit-indicator-container"></div>                     </div>                     <div class="overlay-secondary-container">                         <div class="edit-indicator-container"></div>                     </div>                     <div class="overlay-secondary-container">                         <div class="edit-indicator-container"></div>                     </div>                     <div class="x-axis-row"></div>                     <div id="overlay-navbar-row"></div>                 </div>             </div>         </div>     </div>',P={},Q=ia(),R=u(),T={primary:void 0,secondaries:[],xAxis:sa.xAxis(),navbar:void 0,legend:sa.legend()},U=!1,V=.2,W=!0,X=b.util.render(c),Y=!0;return P.fetchCoinbaseProducts=function(a){return arguments.length?(U=a,P):U},P.changeQuandlProduct=function(a){var b=va.product(a,a,[Q.periods.day1],Q.sources.quandl,".3s"),c=Q.headMenu.products.some(function(a){return a.id===b.id}),d=Q.overlay.products.some(function(a){return a.id===b.id});c||Q.headMenu.products.push(b),d||Q.overlay.products.push(b),q(b),W||X()},P.proportionOfDataToDisplayByDefault=function(a){return arguments.length?(V=a,P):V},P.indicators=function(a){if(!arguments.length){var b=[];return Q.selectors.indicatorSelector.options.forEach(function(a){a.isSelected&&b.push(a.valueString)}),b}return Q.selectors.indicatorSelector.options.forEach(function(b){b.isSelected=a.some(function(a){return a===b.valueString})}),z(),W?A():(B(),X()),P},P.run=function(b){if(!b)throw new Error("An element must be specified when running the application.");var c=a.select(b);c.html(O);var f=c.select("#charts"),g=c.select("#charts-container"),h=c.select("#overlay");G={app:c,charts:g,chartsAndOverlay:f,primary:g.select("#primary-container"),secondaries:g.selectAll(".secondary-container"),xAxis:g.select("#x-axis-container"),navbar:g.select("#navbar-container"),overlay:h,overlaySecondaries:h.selectAll(".overlay-secondary-container"),legend:c.select("#legend"),suspendLayout:function(a){var b=this;Object.keys(b).forEach(function(c){"function"!=typeof b[c]&&b[c].layoutSuspended(a)})}},T.primary=r(),T.navbar=s(),I=v(),J=t(),K=y(),H=C(),M=E(),d(),e(),R(Q.headMenu.selectedPeriod.seconds,Q.headMenu.selectedProduct),U?ja(F):Q.sources.bitcoin&&delete Q.sources.bitcoin},b.util.rebind(P,Q.sources.quandl.historicFeed,{quandlApiKey:"apiKey"}),b.util.rebind(P,R,{periodsOfDataToFetch:"candlesOfData"}),P}a="default"in a?a["default"]:a,b="default"in b?b["default"]:b,c="default"in c?c["default"]:c;var ma={centerOnDate:d,filterDataInDateRange:e,moveToLatest:f,trackingLatestData:g},na=!1,oa=0,pa={domain:ma,layout:h,uid:i,width:j,debounce:k,throttle:l},qa={crosshairChange:"crosshairChange",viewChange:"viewChange",newTrade:"newTrade",historicDataLoaded:"historicDataLoaded",historicFeedError:"historicFeedError",streamingFeedError:"streamingFeedError",streamingFeedClose:"streamingFeedClose",dataProductChange:"dataProductChange",dataPeriodChange:"dataPeriodChange",resetToLatest:"resetToLatest",clearAllPrimaryChartIndicatorsAndSecondaryCharts:"clearAllPrimaryChartIndicatorsAndSecondaryCharts",primaryChartSeriesChange:"primaryChartSeriesChange",primaryChartYValueAccessorChange:"primaryChartYValueAccessorChange",primaryChartIndicatorChange:"primaryChartIndicatorChange",secondaryChartChange:"secondaryChartChange",indicatorChange:"indicatorChange",notificationClose:"notificationClose"},ra={base:n,macd:o,rsi:p,volume:q},sa={legend:s,nav:r,primary:z,xAxis:t,secondary:ra},ta={head:E,selectors:F,navigationReset:G,overlay:I},ua={toast:M},va={period:O,product:P,source:Q},wa={head:U,periodAdaptor:B,productAdaptor:A,overlay:V,dropdownConfig:T,option:u,selector:W},xa={legend:X,nav:Y,navigationReset:Z,primary:$,secondary:_,xAxis:aa},ya={message:N,messages:ba},za={menu:wa,chart:xa,data:va,notification:ya},Aa={app:la};return Aa});