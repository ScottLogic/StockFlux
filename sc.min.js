!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("d3"),require("d3fc")):"function"==typeof define&&define.amd?define(["d3","d3fc"],b):a.sc=b(a.d3,a.fc)}(this,function(a,b){"use strict";function c(){return++ka}function d(a,c){function d(b){return a.secondaries.filter(function(a,c){return c===b})}for(var e=0,f=0;f<c.secondaries.length;f++)c.secondaries[f]&&e++;a.secondaries.filter(function(a,b){return e>b}).style("flex","1"),a.secondaries.filter(function(a,b){return b>=e}).style("flex","0"),a.overlaySecondaries.filter(function(a,b){return e>b}).style("flex","1"),a.overlaySecondaries.filter(function(a,b){return b>=e}).style("flex","0");var g=parseInt(a.app.select(".head-row").style("height"),10);la||(g+=parseInt(a.app.select(".head-row").style("padding-top"),10)+parseInt(a.app.select(".head-row").style("padding-bottom"),10)+parseInt(a.app.select(".head-row").style("margin-bottom"),10),la=!0);var h=b.util.innerDimensions(a.app.node()).height-g;a.charts.style("height",h+"px"),c.xAxis.dimensionChanged(a.xAxis),c.navbar.dimensionChanged(a.navbar),c.primary.dimensionChanged(a.primary);for(var i=0;i<c.secondaries.length;i++)c.secondaries[i].option.dimensionChanged(d(i))}function e(b,c){var d=a.max(b,function(a){return a.getTime()}),e=a.max(c,function(a){return a.date.getTime()});return d===e}function f(a,b){var c=Array.isArray(b)?b:[b,b],d=a[1]-a[0];return[a[0]-d*c[0],a[1]+d*c[1]]}function g(c,d,e){arguments.length<3&&(e=1);var f=b.util.extent().fields("date")(d),g=(f[1].getTime()-f[0].getTime())/1e3,h=c.map(function(a){return a.getTime()}),i=e*(a.max(h)-a.min(h))/1e3,j=g>i?[a.time.second.offset(f[1],-i),f[1]]:f;return j}function h(b,c){var d=a.min(b,function(a){return a.getTime()}),e=a.max(b,function(a){return a.getTime()}),f=c.sort(function(a,b){return a.date-b.date}),g=a.bisector(function(a){return a.date}),h=c.slice(
// Pad and clamp the bisector values to ensure extents can be calculated
Math.max(0,g.left(f,d)-1),Math.min(g.right(f,e)+1,f.length));return h}function i(c,d,e){var f=b.util.extent().fields("date")(d),g=c.map(function(a){return a.getTime()}),h=(a.max(g)-a.min(g))/1e3;if(e.getTime()<f[0]||e.getTime()>f[1])return[new Date(a.min(g)),new Date(a.max(g))];var i=[a.time.second.offset(e,-h/2),a.time.second.offset(e,h/2)],j=0;return i[1].getTime()>f[1].getTime()?j=(f[1].getTime()-i[1].getTime())/1e3:i[0].getTime()<f[0].getTime()&&(j=(f[0].getTime()-i[0].getTime())/1e3),[a.time.second.offset(i[0],j),a.time.second.offset(i[1],j)]}function j(c){function d(a){
// Don't pan off sides
// Don't pan off sides
return a[0]>=0?-a[0]:a[1]<=0?-a[1]:0}function e(a){
// If zooming, and about to pan off screen, do nothing
return a[0]>0&&a[1]<0}function f(a){var b=k.translate()[0];b+=a,k.translate([b,0])}function g(){k.translate([0,0]),k.scale(1)}function h(a){var h=b.util.extent().fields("date")(a.datum().data);k.x(i).on("zoom",function(){var b=i(h[0]),o=i(h[1]),p=e([b,o-c]),q=d([b,o-c]);f(q);var r=1===k.scale(),s=1!==k.scale();if(r&&l||s&&m){var t=i.domain();p?t=h:s&&n&&(t=na.domain.moveToLatest(t,a.datum().data)),t[0].getTime()!==t[1].getTime()?j.zoom(t):
// Ensure the user can't zoom-in infinitely, causing the chart to fail to render
// #168, #411
g()}else g()}),a.call(k)}var i,j=a.dispatch("zoom"),k=a.behavior.zoom(),l=!0,m=!0,n=!0;return h.allowPan=function(a){return arguments.length?(l=a,h):l},h.allowZoom=function(a){return arguments.length?(m=a,h):m},h.trackingLatest=function(a){return arguments.length?(n=a,h):n},h.scale=function(a){return arguments.length?(i=a,h):i},a.rebind(h,j,"on"),h}function k(){function c(b){b.each(function(c){var g=a.select(this).call(l),i=j(d).scale(f).trackingLatest(h).on("zoom",function(a){e[oa.viewChange](a)});g.select(".plot-area-container").datum({data:b.datum()}).call(i)})}var d,e=a.dispatch(oa.viewChange),f=b.scale.dateTime(),g=a.scale.linear(),h=!0,i=60,k=b.series.multi(),l=b.chart.cartesian(f,g).plotArea(k).xTicks(0).yOrient("right").margin({top:0,left:0,bottom:0,right:i});return c.trackingLatest=function(a){return arguments.length?(h=a,c):h},a.rebind(c,e,"on"),a.rebind(c,k,"series","mapping","decorate"),a.rebind(c,l,"yTickValues","yTickFormat","yTicks","xDomain","yDomain"),c.dimensionChanged=function(a){d=parseInt(a.style("width"),10)-i},c}function l(){function c(a){a.each(function(c){var d=b.util.extent().fields("volume").pad(.08)(c.data);d[0]<0&&(d[0]=0),f.yTickFormat(c.product.volumeFormat).trackingLatest(c.trackingLatest).xDomain(c.viewDomain).yDomain(d),a.datum(c.data).call(f)})}var d=a.dispatch(oa.viewChange),e=b.series.bar().yValue(function(a){return a.volume}),f=k().series([e]).yTicks(4).on(oa.viewChange,function(a){d[oa.viewChange](a)});return a.rebind(c,d,"on"),c.dimensionChanged=function(a){f.dimensionChanged(a)},c}function m(){function c(a){var b=a.datum();f(b.data),h.trackingLatest(b.trackingLatest).xDomain(b.viewDomain).yDomain([0,100]),a.datum(b.data).call(h)}var d=a.dispatch(oa.viewChange),e=b.indicator.renderer.relativeStrengthIndex(),f=b.indicator.algorithm.relativeStrengthIndex(),g=[e.lowerValue(),50,e.upperValue()],h=k().series([e]).yTickValues(g).on(oa.viewChange,function(a){d[oa.viewChange](a)});return a.rebind(c,d,"on"),c.dimensionChanged=function(a){h.dimensionChanged(a)},c}function n(){function c(a){var c=a.datum();g(c.data);var d=b.util.extent().fields("macd").symmetricalAbout(0).pad(.08)(c.data.map(function(a){return a.macd}));h.trackingLatest(c.trackingLatest).xDomain(c.viewDomain).yDomain(d),a.datum(c.data).call(h)}var d=a.dispatch(oa.viewChange),e=b.annotation.line().value(0).label(""),f=b.indicator.renderer.macd(),g=b.indicator.algorithm.macd(),h=k().series([e,f]).yTicks(5).mapping(function(a){return a===e?[0]:this}).decorate(function(a){a.enter().attr("class",function(a,b){return["multi zero","multi"][b]})}).on(oa.viewChange,function(a){d[oa.viewChange](a)});return a.rebind(c,d,"on"),c.dimensionChanged=function(a){h.dimensionChanged(a)},c}function o(){function c(a){var b=(e.ticks()[1]-e.ticks()[0])/1e3;b<a.seconds?f.ticks(a.d3TimeInterval.unit,a.d3TimeInterval.value):f.ticks(6)}function d(a){var b=a.datum();e.domain(b.viewDomain),c(b.period),a.call(f)}var e=b.scale.dateTime(),f=a.svg.axis().scale(e).orient("bottom");return d.dimensionChanged=function(a){e.range([0,parseInt(a.style("width"),10)])},d}function p(a,b,c,d,e){return{displayString:a,// TODO: is 'displayName' better?
valueString:b,// TODO: is this an id?
option:c,// TODO: Ideally, remove.
isSelected:!1,icon:d,isPrimary:e}}function q(){var c=b.scale.dateTime(),d=a.scale.linear(),e=b.util.fractionalBarWidth(.75),f=function(a,b){return a.date},g=function(a,b){return c(f(a,b))},h=function(a){return a.low},i=function(a){return a.high},j=function(a,b){return a.close},k=b.svg.candlestick().x(function(a){return c(a.date)}).open(function(a){return d(a.open)}).high(function(a){return d(i(a))}).low(function(a){return d(h(a))}).close(function(a){return d(a.close)}),l=b.util.dataJoin().selector("path.up").element("path").attr("class","up"),m=b.util.dataJoin().selector("path.down").element("path").attr("class","down"),n=function(a){a.each(function(a){k.width(e(a.map(g)));var b=a.filter(function(a){return a.open<a.close}),c=a.filter(function(a){return a.open>=a.close});l(this,[b]).attr("d",k),m(this,[c]).attr("d",k)})};return n.xScale=function(a){return arguments.length?(c=a,n):c},n.yScale=function(a){return arguments.length?(d=a,n):d},n.xValue=function(a){return arguments.length?(f=a,n):f},n.yLowValue=function(a){return arguments.length?(h=a,n):h},n.yHighValue=function(a){return arguments.length?(i=a,n):i},n.yCloseValue=function(a){return arguments.length?(j=a,n):j},n.width=function(a){return e(a.map(g))},n}function r(a,b){var c=b/2;return[[0,0],[c,-c],[a,-c],[a,c],[c,c],[0,0]]}function s(a,b){for(var c=a.ticks.apply(a,[]),d=a.domain(),e=0;e<b.length;e++)b[e]>d[0]&&b[e]<d[1]&&c.push(b[e]);return c}function t(c,d,e){var f;switch(d.valueString){case"candlestick":case"ohlc":f=[d.option.yLowValue(),d.option.yHighValue()];break;case"line":case"point":f=d.option.yValue();break;case"area":f=d.option.y1Value();break;default:throw new Error("Main series given to chart does not have expected interface")}var g=b.util.extent().fields(f)(c);if(e.length){var h=e.map(function(a){return a.valueString}),i=-1!==h.indexOf("movingAverage"),j=-1!==h.indexOf("bollinger");if(j){var k=c.map(function(a){return a.bollingerBands}),l=b.util.extent().fields(["lower","upper"])(k);g[0]=a.min([l[0],g[0]]),g[1]=a.max([l[1],g[1]])}if(i){var m=b.util.extent().fields("movingAverage")(c);g[0]=a.min([m[0],g[0]]),g[1]=a.max([m[1],g[1]])}if(!i&&!j)throw new Error("Unexpected indicator type")}return g}function u(){function c(){var a=[v,k.option,w],b=p.map(function(a){return a.option});return a.concat(b,u)}function d(){switch(B.value(o),C.value(o),w.value(o),k.valueString){case"line":case"point":case"area":k.option.yValue(o)}}
// Call when what to display on the chart is modified (ie series, options)
function e(a){k=a.series,o=a.yValueAccessor.option,p=a.indicators,d(),x.series(c()),A.yTickFormat(a.product.priceFormat),a.selectorsChanged=!1}function f(a){var b=k.option.width(a);u.decorate(function(a){a.classed("band hidden-xs hidden-sm",!0),a.selectAll(".vertical > line").style("stroke-width",b)})}function g(a){a.classed("band",!1).classed("hidden-xs hidden-sm",!0).selectAll("line").style("stroke-width",null)}function h(a){"candlestick"===k.valueString||"ohlc"===k.valueString?f(a):u.decorate(g)}function i(c){var d=c.datum();d.selectorsChanged&&e(d),A.xDomain(d.viewDomain),u.snap(b.util.seriesPointSnapXOnly(k.option,d.data)),h(d.data),B(d.data),C(d.data);
// Scale y axis
var f=na.domain.filterDataInDateRange(A.xDomain(),d.data),g=t(f,k,p),i=na.domain.padYDomain(g,.04);A.yDomain(i);
// Find current tick values and add close price to this list, then set it explicitly below
var q=o(d.data[d.data.length-1]),v=s(z,[q]);A.yTickValues(v).yDecorate(function(b){b.selectAll(".tick").filter(function(a){return a===q}).classed("closeLine",!0).select("path").attr("d",function(b){return a.svg.area()(r(m,14))})}),
// Redraw
A.plotArea(x),c.call(A);var w=j(l).scale(y).trackingLatest(d.trackingLatest).on("zoom",function(a){n[oa.viewChange](a)});c.select(".plot-area").call(w)}var k,l,m=60,n=a.dispatch(oa.viewChange,oa.crosshairChange),o=function(a){return a.close},p=[],q=[],u=b.tool.crosshair().xLabel("").yLabel("").on("trackingmove",function(a){a.length>0?n.crosshairChange(a[0].datum):n.crosshairChange(void 0)}).on("trackingend",function(){n.crosshairChange(void 0)});u.id=na.uid();var v=b.annotation.gridline().yTicks(5).xTicks(0),w=b.annotation.line().orient("horizontal").value(o).label("");w.id=na.uid();var x=b.series.multi().key(function(a){return a.id}).mapping(function(a){switch(a){case w:return[this.data[this.data.length-1]];case u:return q;default:return this.data}}),y=b.scale.dateTime(),z=a.scale.linear(),A=b.chart.cartesian(y,z).xTicks(0).yOrient("right").margin({top:0,left:0,bottom:0,right:m}),B=b.indicator.algorithm.movingAverage(),C=b.indicator.algorithm.bollingerBands();
// Call when the main layout is modified
return a.rebind(i,n,"on"),i.dimensionChanged=function(a){l=parseInt(a.style("width"),10)-m},i}function v(){function c(a,b){a.select(".plot-area").selectAll(".e, .w").classed("hidden",b)}function d(a){return a.extent()[0][0]-a.extent()[1][0]===0}function e(a){var e=a.datum();s.domain(e.viewDomain);var g=na.domain.filterDataInDateRange(b.util.extent().fields("date")(e.data),e.data),h=b.util.extent().fields(["low","high"])(g);r.xDomain(b.util.extent().fields("date")(e.data)).yDomain(h),v.on("brush",function(){var b=d(v);
// Hide the bar if the extent is empty
c(a,b),b||q[oa.viewChange]([v.extent()[0][0],v.extent()[1][0]])}).on("brushend",function(){var b=d(v);c(a,!1),b&&q[oa.viewChange](na.domain.centerOnDate(s.domain(),e.data,v.extent()[0][0]))}),r.plotArea(w),a.call(r);
// Allow to zoom using mouse, but disable panning
var i=j(f).scale(s).trackingLatest(e.trackingLatest).allowPan(!1).on("zoom",function(a){q[oa.viewChange](a)});a.select(".plot-area").call(i)}var f,g=100,h=40,i=g-h,k=2,l=k/2,m=i-l,n=m,o=l+n/2,p=2,q=a.dispatch(oa.viewChange),r=b.chart.cartesian(b.scale.dateTime(),a.scale.linear()).yTicks(0).margin({bottom:h}),s=b.scale.dateTime(),t=b.series.area().yValue(function(a){return a.close}),u=b.series.line().yValue(function(a){return a.close}),v=a.svg.brush(),w=b.series.multi().series([t,u,v]).decorate(function(a){var b=a.enter();a.select(".extent").attr("height",m).attr("y",k/2),
// overload d3 styling for the brush handles
// as Firefox does not react properly to setting these through less file.
b.selectAll(".resize.w>rect, .resize.e>rect").attr("width",p).attr("x",-p/2),a.selectAll(".resize.w>rect, .resize.e>rect").attr("height",n).attr("y",l);
// Adds the handles to the brush sides
var c=b.selectAll(".e, .w");c.append("circle").attr("cy",o).attr("r",7).attr("class","outer-handle"),c.append("circle").attr("cy",o).attr("r",4).attr("class","inner-handle")}).mapping(function(a){return a!==v?this.data:void v.extent([[s.domain()[0],r.yDomain()[0]],[s.domain()[1],r.yDomain()[1]]])});return a.rebind(e,q,"on"),e.dimensionChanged=function(a){f=parseInt(a.style("width"),10),s.range([0,f])},e}function w(){function b(b){b.each(function(b){var h=a.select(this);if(c=b.product.priceFormat,d=b.product.volumeFormat,e=b.period.timeFormat,null==b.data||b.data!==f){f=b.data;var i=h.selectAll("span").data(g);i.enter().append("span").attr("class",function(a,b){return b%2===0?"legendLabel":"legendValue"}),i.text(function(a,c){var d="";return c%2===0?a:b.data?a(b.data):d})}})}var c,d,e,f,g=["T",function(a){return e(a.date)},"O",function(a){return c(a.open)},"H",function(a){return c(a.high)},"L",function(a){return c(a.low)},"C",function(a){return c(a.close)},"V",function(a){return d(a.volume)}];return b}function x(){function b(b){b.each(function(b){var d=a.select(this),e=d.selectAll("div").data(b.selectedIndicators,function(a){return a.valueString}),f=e.enter().append("div").attr("class","edit-indicator");f.append("span").attr("class","icon sc-icon-delete").on("click",c.indicatorChange),f.append("span").attr("class","indicator-label").text(function(a){return a.displayString}),e.exit().remove()})}var c=a.dispatch(oa.indicatorChange);return a.rebind(b,c,"on"),b}function y(){var b=a.dispatch(oa.primaryChartIndicatorChange,oa.secondaryChartChange),c=x().on(oa.indicatorChange,b[oa.primaryChartIndicatorChange]),d=x().on(oa.indicatorChange,b[oa.secondaryChartChange]),e=function(b){b.each(function(b){var e=a.select(this);e.select("#overlay-primary-container .edit-indicator-container").datum({selectedIndicators:b.primaryIndicators}).call(c),e.selectAll(".overlay-secondary-container").each(function(c,e){var f=a.select(this),g=b.secondaryIndicators[e]?[b.secondaryIndicators[e]]:[];f.select(".edit-indicator-container").datum({selectedIndicators:g}).call(d)})})};return a.rebind(e,b,"on"),e}function z(){function b(a){var b=a.datum(),d=a.selectAll("g").data([b]);d.enter().append("g").attr("class","reset-button").on("click",function(){c[oa.resetToLatest]()}).append("path").attr("d","M1.5 1.5h13.438L23 20.218 14.937 38H1.5l9.406-17.782L1.5 1.5z"),d.classed("active",!b.trackingLatest)}var c=a.dispatch(oa.resetToLatest);return a.rebind(b,c,"on"),b}function A(){function c(a){var b=a.datum(),c=b.selectedIndex||0,i=b.config,j=e(a,[b.options]);if(i.icon){var k=j.selectAll(".icon").data([0]);k.enter().append("span"),k.attr("class","icon "+b.options[c].icon)}else j.select(".icon").remove(),j.text(function(){return i.title||b.options[c].displayString});f(j,i.careted?[0]:[]);var l=g(a,[b.options]),m=h(l,b.options),n=m.enter().on("click",d.optionChange).append("a").attr("href","#");n.append("span").attr("class","icon"),n.append("span").attr("class","name"),m.selectAll(".icon").attr("class",function(a){return"icon "+a.icon}),m.selectAll(".name").text(function(a){return a.displayString})}var d=a.dispatch("optionChange"),e=b.util.dataJoin().selector("button").element("button").attr({"class":"dropdown-toggle",type:"button","data-toggle":"dropdown"}),f=b.util.dataJoin().selector(".caret").element("span").attr("class","caret"),g=b.util.dataJoin().selector("ul").element("ul").attr("class","dropdown-menu"),h=b.util.dataJoin().selector("li").element("li").key(function(a){return a.displayString});return a.rebind(c,d,"on"),c}function B(){var b=a.dispatch(oa.primaryChartSeriesChange,oa.primaryChartIndicatorChange,oa.secondaryChartChange),c=A().on("optionChange",b[oa.primaryChartSeriesChange]),d=A().on("optionChange",function(a){a.isPrimary?b[oa.primaryChartIndicatorChange](a):b[oa.secondaryChartChange](a)}),e=function(b){b.each(function(b){var e=a.select(this),f=b.seriesSelector.options.map(function(a){return a.isSelected}).indexOf(!0);e.select("#series-dropdown").datum({config:b.seriesSelector.config,options:b.seriesSelector.options,selectedIndex:f}).call(c);var g=b.indicatorSelector.options,h=g.map(function(a,b){return a.isSelected?b:null}).filter(function(a){return a});e.select("#indicator-dropdown").datum({config:b.indicatorSelector.config,options:g,selected:h}).call(d)})};return a.rebind(e,b,"on"),e}
// Generates a menu option similar to those generated by sc.model.menu.option from a sc.model.data.product object
function C(a){return{displayString:a.display,option:a}}
// Generates a menu option similar to those generated by model.menu.option from a model.data.period object
function D(a){return{displayString:a.display,option:a}}function E(){function c(a){var c=a.datum().selectedIndex||0,f=e(a,[a.datum().options]);f.enter().append("ul");var g=f.selectAll("li").data(b.util.fn.identity);g.enter().append("li").append("a").attr("href","#").on("click",d.tabClick),g.classed("active",function(a,b){return b===c}).select("a").text(function(a){return a.displayString}),g.exit().remove()}var d=a.dispatch("tabClick"),e=b.util.dataJoin().selector("ul").element("ul");return a.rebind(c,d,"on"),c}function F(){var b=a.dispatch(oa.dataProductChange,oa.dataPeriodChange,oa.clearAllPrimaryChartIndicatorsAndSecondaryCharts),c=A().on("optionChange",b[oa.dataProductChange]),d=E().on("tabClick",b[oa.dataPeriodChange]),e=A().on("optionChange",b[oa.dataPeriodChange]),f=function(f){f.each(function(f){var g=a.select(this),h=f.products;g.select("#product-dropdown").datum({config:f.productConfig,options:h.map(C),selectedIndex:h.map(function(a){return a.id}).indexOf(f.selectedProduct.id)}).call(c);var i=f.selectedProduct.periods;g.select("#period-selector").classed("hidden",i.length<=1).datum({options:i.map(D),selectedIndex:i.indexOf(f.selectedPeriod)}).call(d),g.select("#mobile-period-selector").classed("hidden",i.length<=1).datum({config:f.mobilePeriodConfig,options:i.map(D),selectedIndex:i.indexOf(f.selectedPeriod)}).call(e),g.select("#clear-indicators").on("click",b[oa.clearAllPrimaryChartIndicatorsAndSecondaryCharts])})};return a.rebind(f,b,"on"),f}function G(){function a(a){var c=++b;return function(d,e){b>c||a(d,e)}}var b=0;return a.invalidateCallback=function(){return b++,a},a}function H(){function b(a){var b=1e3*f;return new Date(Math.floor(a.getTime()/b)*b)}var c=function(a){return a.date},d=function(a){return Number(a.volume)},e=function(a){return Number(a.price)},f=60,g=function(f,g){var h=b(c(g)),i=e(g),j=d(g),k=a.bisector(function(a){return a.date}).left,l=f.filter(function(a){return a.date.getTime()===h.getTime()})[0];l?(l.high=Math.max(i,l.high),l.low=Math.min(i,l.low),l.close=i,l.volume+=j):f.splice(k(f,h),0,{date:h,open:i,high:i,low:i,close:i,volume:j})};return g.granularity=function(a){return arguments.length?(f=a,g):f},g.price=function(a){return arguments.length?(e=a,g):e},g.volume=function(a){return arguments.length?(d=a,g):d},g.date=function(a){return arguments.length?(c=a,g):c},g}function I(){function b(){f&&f.streamingFeed&&f.streamingFeed.close(),k=[],i.invalidateCallback()}function c(a){return a.sort(function(a,b){return a.date-b.date})}function d(){null!=f.streamingFeed&&(f.streamingFeed.on("message",function(a){h(k,a),g[oa.newTrade](k,f)}).on("error",function(a){g[oa.streamingFeedError](a,f)}).on("close",function(a){g[oa.streamingFeedClose](a,f)}),f.streamingFeed())}function e(a,e){b(),2===arguments.length&&(f=e.source,f.historicFeed.product(e.id),null!=f.streamingFeed&&f.streamingFeed.product(e.id));var l=new Date;f.historicFeed.end(l).candles(j).granularity(a),h.granularity(a),f.historicFeed(i(function(a,b){a?g[oa.historicFeedError](a,f):(k=c(b),g[oa.historicDataLoaded](k,f),d())}))}var f,g=a.dispatch(oa.newTrade,oa.historicDataLoaded,oa.historicFeedError,oa.streamingFeedError,oa.streamingFeedClose),h=H().date(function(a){return new Date(a.time)}).volume(function(a){return Number(a.size)}),i=G(),j=200,k=[];return a.rebind(e,g,"on"),e}function J(){var c=a.dispatch(oa.notificationClose),d=b.util.dataJoin().selector("div.alert-content").element("div").attr("class","alert-content"),e=b.util.dataJoin().selector("div.alert").element("div").attr({"class":"alert alert-info alert-dismissible",role:"alert"}).key(function(a){return a.id}),f=function(b){b.each(function(b){var f=a.select(this),g=d(f,[b]);g.enter().html('<div class="messages"></div>');var h=e(g.select(".messages"),b.messages),i=h.enter();i.html('<button type="button" class="close" aria-label="Close">                     <span aria-hidden="true">&times;</span>                 </button>                 <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>                 <span class="sr-only">Error:</span>                 <span class="message"></span>'),i.select(".close").on("click",function(a){c[oa.notificationClose](a.id)}),h.select(".message").text(function(a){return a.message})})};return a.rebind(f,c,"on"),f}function K(a){return{id:na.uid(),message:a}}function L(a,b,c,d){return{historicFeed:a,historicNotificationFormatter:b,streamingFeed:c,streamingNotificationFormatter:d}}function M(b,c,d,e,f,g){return{id:b,display:c||"Unspecified Product",priceFormat:a.format(g||".2f"),volumeFormat:a.format(f||".2f"),periods:d||[],source:e}}function N(b,c,d,e){return{display:b||"1 day",seconds:c||86400,d3TimeInterval:d||{unit:a.time.day,value:1},timeFormat:a.time.format(e||"%b %d")}}function O(a){var b;if(a.wasClean===!1&&1e3!==a.code&&1006!==a.code){var c=a.reason||"Unkown reason.";b="Disconnected from live stream: "+a.code+" "+c}return b}function P(a){var b;
// The WebSocket's error event doesn't contain much useful information,
// so the close event is used to report errors instead
return"error"===a.type&&a.message?b="Live stream error: "+a.message:"close"===a.type&&(b=O(a)),b}function Q(){return{messages:[]}}function R(a){return{viewDomain:[],period:a}}function S(a){return{data:[],viewDomain:[],trackingLatest:!0,product:a}}function T(a){var b={data:[],trackingLatest:!0,viewDomain:[],selectorsChanged:!0},c=a;Object.defineProperty(b,"product",{get:function(){return c},set:function(a){c=a,b.selectorsChanged=!0}});var d=q();d.id=na.uid();var e=p("Candlestick","candlestick",d);Object.defineProperty(b,"series",{get:function(){return e},set:function(a){e=a,b.selectorsChanged=!0}});var f={option:function(a){return a.close}};Object.defineProperty(b,"yValueAccessor",{get:function(){return f},set:function(a){f=a,b.selectorsChanged=!0}});var g=[];return Object.defineProperty(b,"indicators",{get:function(){return g},set:function(a){g=a,b.selectorsChanged=!0}}),b}function U(){return{trackingLatest:!0}}function V(){return{data:[],viewDomain:[],trackingLatest:!0}}function W(a,b){return{data:void 0,product:a,period:b}}function X(a,b){return{config:a,options:b}}function Y(a,b,c,d){return{title:a||null,careted:b||!1,listIcons:c||!1,icon:d||!1}}function Z(){return{primaryIndicators:[],secondaryIndicators:[]}}function $(a,b,c){return{productConfig:Y(null,!0),mobilePeriodConfig:Y(),products:a,selectedProduct:b,selectedPeriod:c,alertMessages:[]}}function _(){var a,c,d,e=b.data.random.financial(),f=[86400],g=null,h=function(b){c.setHours(0,0,0,0);var d=864e5;e.startDate(new Date(c-(a-1)*d));var f=e(a);b(null,f)};return h.candles=function(b){return arguments.length?(a=b,h):a},h.end=function(a){return arguments.length?(c=a,h):c},h.granularity=function(a){if(!arguments.length)return d;if(-1===f.indexOf(a))throw new Error("Granularity of "+a+" is not supported. Random Financial Data Generator only supports daily data.");return d=a,h},h.product=function(a){if(!arguments.length)return h;if(null!==a)throw new Error("Random Financial Data Generator does not support products.");return g=a,h},h}
// Inspired by underscore library implementation of debounce
function aa(a,b,c){var d,e,f,g,h=function(){var i=(new Date).getTime()-f;b>i&&i>=0?d=setTimeout(h.bind(this),b-i):(d=null,c||(g=a.apply(this,e),e=null))};return function(){e=arguments,f=(new Date).getTime();var i=c&&!d;return d||(d=setTimeout(h.bind(this),b)),i&&(g=a.apply(this,e),e=null),g}}function ba(){var c,d=1e3,e=b.data.feed.coinbase(),f=aa(function(b){var d=a.time.second.offset(e.end(),-c*e.granularity());e.start(d),e(b)},d);return f.candles=function(a){return arguments.length?(c=a,f):c},a.rebind(f,e,"end","granularity","product"),f}function ca(a){var b;return a&&(b=a.message),b}
// https://docs.exchange.coinbase.com/#websocket-feed
function da(){var b,c="BTC-USD",d=a.dispatch("open","close","error","message"),e="match",f=function(a,f){a=a||"wss://ws-feed.exchange.coinbase.com",f=f||{type:"subscribe",product_id:c},b=new WebSocket(a),b.onopen=function(a){b.send(JSON.stringify(f)),d.open(a)},b.onerror=function(a){d.error(a)},b.onclose=function(a){d.close(a)},b.onmessage=function(a){var b=JSON.parse(a.data);b.type===e?d.message(b):"error"===b.type&&d.error(b)}};return a.rebind(f,d,"on"),f.close=function(){
// Only close the WebSocket if it is opening or open
!b||b.readyState!==WebSocket.CONNECTING&&b.readyState!==WebSocket.OPEN||b.close()},f.messageType=function(a){return arguments.length?(e=a,f):e},f.product=function(a){return arguments.length?(c=a,f):c},f}function ea(){function c(b){var c=a.time.second.offset(f.end(),-e*d);f.apiKey("kM9Z9aEULVDD7svZ4A8B"),f.start(c).collapse(g.get(d)),f(b)}var d,e,f=b.data.feed.quandl(),g=a.map();return g.set(86400,"daily"),g.set(604800,"weekly"),c.candles=function(a){return arguments.length?(e=a,c):e},c.granularity=function(a){if(!arguments.length)return d;if(!g.has(a))throw new Error("Granularity of "+a+" is not supported.");return d=a,c},b.util.rebind(c,f,{end:"end",product:"dataset"}),c}function fa(a){var b;return a&&a.quandl_error&&(b=a.quandl_error.message),b}function ga(b){a.json("https://api.exchange.coinbase.com/products",function(a,c){return a?void b(a):void b(a,c)})}function ha(a,b,c,d){return a.map(function(a){return xa.data.product(a.id,a.id,d.get(a.id)||c,b)})}function ia(c){function d(){return{week1:xa.data.period("Weekly",604800,{unit:a.time.week,value:1},"%b %d"),day1:xa.data.period("Daily",86400,{unit:a.time.day,value:1},"%b %d"),hour1:xa.data.period("1 Hr",3600,{unit:a.time.hour,value:1},"%b %d %Hh"),minute5:xa.data.period("5 Min",300,{unit:a.time.minute,value:5},"%H:%M"),minute1:xa.data.period("1 Min",60,{unit:a.time.minute,value:1},"%H:%M")}}function e(){return{generated:xa.data.source(_(),null,null),bitcoin:xa.data.source(ba(),ca,da(),P),quandl:xa.data.source(ea(),fa,null,null)}}function f(){return{generated:xa.data.product(null,"Data Generator",[l.day1],m.generated,".3s"),quandl:xa.data.product("GOOG","GOOG",[l.day1,l.week1],m.quandl,".3s")}}function g(){var a=q();a.id=na.uid();var c=xa.menu.option("Candlestick","candlestick",a,"sc-icon-candlestick-series");c.isSelected=!0;var d=b.series.ohlc();d.id=na.uid();var e=b.series.line();e.id=na.uid();var f=b.series.point();f.id=na.uid();var g=b.series.area();g.id=na.uid();var h=xa.menu.dropdownConfig(null,!1,!0,!0),i=[c,xa.menu.option("OHLC","ohlc",d,"sc-icon-ohlc-series"),xa.menu.option("Line","line",e,"sc-icon-line-series"),xa.menu.option("Point","point",f,"sc-icon-point-series"),xa.menu.option("Area","area",g,"sc-icon-area-series")];return xa.menu.selector(h,i)}function h(){var a=qa.secondary,c=b.series.line().decorate(function(a){a.enter().classed("movingAverage",!0)}).yValue(function(a){return a.movingAverage});c.id=na.uid();var d=b.indicator.renderer.bollingerBands();d.id=na.uid();var e=[xa.menu.option("Moving Average","movingAverage",c,"sc-icon-moving-average-indicator",!0),xa.menu.option("Bollinger Bands","bollinger",d,"sc-icon-bollinger-bands-indicator",!0),xa.menu.option("Relative Strength Index","secondary-rsi",a.rsi(),"sc-icon-rsi-indicator",!1),xa.menu.option("MACD","secondary-macd",a.macd(),"sc-icon-macd-indicator",!1),xa.menu.option("Volume","secondary-volume",a.volume(),"sc-icon-bar-series",!1)];return e}function i(){var a=xa.menu.dropdownConfig("Add Indicator",!1,!0);return xa.menu.selector(a,h())}function j(){return{seriesSelector:g(),indicatorSelector:i()}}var k={},l=d(),m=e(),n=f();// TODO: remove if unused
// TODO: remove if unused
return ga(function(b,d){if(b){var e=b.statusText||"Unknown reason.",f="Error retrieving Coinbase products: "+e;c.updateModel(function(a){a.notificationMessages.messages.unshift(K(f))})}else{var g=[l.hour1,l.day1],h=a.map();h.set("BTC-USD",[l.minute1,l.minute5,l.hour1,l.day1]);var i=ha(d,m.bitcoin,g,h);c.updateModel(function(a){a.headMenu.products=a.headMenu.products.concat(i)})}}),k.periods=l,k.sources=m,k.primaryChart=xa.chart.primary(n.generated),k.secondaryChart=xa.chart.secondary(n.generated),k.selectors=j(),k.xAxis=xa.chart.xAxis(l.day1),k.nav=xa.chart.nav(),k.navReset=xa.chart.navigationReset(),k.headMenu=xa.menu.head([n.generated,n.quandl],n.generated,l.day1),k.legend=xa.chart.legend(n.generated,l.day1),k.overlay=xa.menu.overlay(),k.notificationMessages=xa.notification.messages(),k}function ja(c){function d(){T||(T=!0),V&&F.suspendLayout(!1),F.primary.datum(R.primaryChart).call(S.primary),F.legend.datum(R.legend).call(S.legend),F.secondaries.datum(R.secondaryChart).filter(function(a,b){return b<S.secondaries.length}).each(function(b,c){a.select(this).attr("class","secondary-container "+S.secondaries[c].valueString).call(S.secondaries[c].option)}),F.xAxis.datum(R.xAxis).call(S.xAxis),F.navbar.datum(R.nav).call(S.navbar),F.app.select("#navbar-reset").datum(R.navReset).call(L),F.app.select(".head-menu").datum(R.headMenu).call(J),F.app.select("#selectors").datum(R.selectors).call(M),F.app.select("#notifications").datum(R.notificationMessages).call(N),F.overlay.datum(R.overlay).call(H),V&&(F.suspendLayout(!0),V=!1)}function e(){V=!0,na.layout(F,S)}function f(){a.select(window).on("resize",function(){e(),U()})}function g(a){R.notificationMessages.messages.unshift(K(a))}function h(a){var b=[a[0],a[1]];R.primaryChart.viewDomain=b,R.secondaryChart.viewDomain=b,R.xAxis.viewDomain=b,R.nav.viewDomain=b;var c=na.domain.trackingLatestData(R.primaryChart.viewDomain,R.primaryChart.data);R.primaryChart.trackingLatest=c,R.secondaryChart.trackingLatest=c,R.nav.trackingLatest=c,R.navReset.trackingLatest=c,U()}function i(a){a.isSelected=!a.isSelected,A(),U()}function j(a){a.isSelected=!a.isSelected,B(),U()}function k(a){R.legend.data=a,U()}function l(a,b){var c;c=b.streamingNotificationFormatter?b.streamingNotificationFormatter(a):P(a),c&&(g(c),U())}function m(){var a=R.primaryChart.data,c=b.util.extent().fields("date")(a),d=na.domain.moveToLatest(c,a,.2);h(d)}function n(a,b){F.app.select("#loading-status-message").classed("hidden",!(a||b)).select(".content").text(b||"Loading..."),F.app.select("#charts").classed("hidden",a||b)}function o(a){R.primaryChart.data=a,R.secondaryChart.data=a,R.nav.data=a}function p(a){R.headMenu.selectedProduct=a,R.primaryChart.product=a,R.secondaryChart.product=a,R.legend.product=a}function q(a){R.headMenu.selectedPeriod=a,R.xAxis.period=a,R.legend.period=a}function r(a){n(!0),p(a),q(a.periods[0]),G(a.periods[0].seconds,a)}function s(){return qa.primary().on(oa.crosshairChange,k).on(oa.viewChange,h)}function t(){return qa.nav().on(oa.viewChange,h)}function u(){return ra.navigationReset().on(oa.resetToLatest,m)}function v(){return I().on(oa.newTrade,function(a,b){if(o(a),R.primaryChart.trackingLatest){var c=na.domain.moveToLatest(R.primaryChart.viewDomain,R.primaryChart.data);h(c)}}).on(oa.historicDataLoaded,function(a,b){n(!1),o(a),R.legend.data=null,m(),e()}).on(oa.historicFeedError,function(a,b){n(!1,"Error loading data. Please make your selection again, or refresh the page.");var c="";try{var d=JSON.parse(a.responseText),e=b.historicNotificationFormatter(d);e&&(c=". "+e)}catch(f){c=""}var h=a.statusText||"Unknown reason.",i="Error getting historic data: "+h+c;g(i),U()}).on(oa.streamingFeedError,l).on(oa.streamingFeedClose,l)}function w(){return ra.head().on(oa.dataProductChange,function(a){r(a.option),U()}).on(oa.dataPeriodChange,function(a){n(!0),q(a.option),G(a.option.seconds),U()}).on(oa.clearAllPrimaryChartIndicatorsAndSecondaryCharts,function(){R.primaryChart.indicators.forEach(y),S.secondaries.forEach(y),A(),B(),U()})}function x(a,b){b.forEach(function(a){a.isSelected=!1}),a.isSelected=!0}function y(a){a.isSelected=!1}function z(){return ra.selectors().on(oa.primaryChartSeriesChange,function(a){R.primaryChart.series=a,x(a,R.selectors.seriesSelector.options),U()}).on(oa.primaryChartIndicatorChange,i).on(oa.secondaryChartChange,j)}function A(){R.primaryChart.indicators=R.selectors.indicatorSelector.options.filter(function(a){return a.isSelected&&a.isPrimary}),R.overlay.primaryIndicators=R.primaryChart.indicators}function B(){S.secondaries=R.selectors.indicatorSelector.options.filter(function(a){return a.isSelected&&!a.isPrimary}),
// TODO: This doesn't seem to be a concern of menu.
S.secondaries.forEach(function(a){a.option.on(oa.viewChange,h)}),R.overlay.secondaryIndicators=S.secondaries,
// TODO: Remove .remove! (could a secondary chart group component manage this?).
F.secondaries.selectAll("*").remove(),e()}function C(){return ra.overlay().on(oa.primaryChartIndicatorChange,i).on(oa.secondaryChartChange,j)}function D(a){R.notificationMessages.messages=R.notificationMessages.messages.filter(function(b){return b.id!==a}),U()}function E(){return sa.toast().on(oa.notificationClose,D)}var F,G,H,J,L,M,N,O='<div class="container-fluid">         <div id="notifications"></div>         <div class="row head-menu head-row">             <div class="col-md-12 head-sub-row">                 <div id="product-dropdown" class="dropdown product-dropdown"></div>                 <div id="period-selector" class="hidden-xs hidden-sm"></div>                 <div id="mobile-period-selector" class="hidden-md hidden-lg dropdown"></div>                 <span id="clear-indicators" class="icon sc-icon-delete delete-button hidden-md hidden-lg"></span>             </div>         </div>         <div class="row primary-row">             <div class="col-md-12" id="loading-status-message">                 <p class="content">Loading...</p>             </div>             <div id="charts" class="col-md-12 hidden">                 <div id="charts-container">                     <svg id="primary-container"></svg>                     <svg class="secondary-container"></svg>                     <svg class="secondary-container"></svg>                     <svg class="secondary-container"></svg>                     <div class="x-axis-row">                         <svg id="x-axis-container"></svg>                     </div>                     <div id="navbar-row" class="hidden-xs hidden-sm">                         <svg id="navbar-container"></svg>                         <svg id="navbar-reset"></svg>                     </div>                 </div>                 <div id="overlay">                     <div id="overlay-primary-container">                         <div id="overlay-primary-head">                             <div id="selectors">                                 <div id="series-dropdown" class="dropdown selector-dropdown"></div>                                 <div id="indicator-dropdown" class="dropdown selector-dropdown"></div>                             </div>                             <div id="legend" class="hidden-xs hidden-sm"></div>                         </div>                         <div id="overlay-primary-bottom">                             <div class="edit-indicator-container"></div>                         </div>                     </div>                     <div class="overlay-secondary-container">                         <div class="edit-indicator-container"></div>                     </div>                     <div class="overlay-secondary-container">                         <div class="edit-indicator-container"></div>                     </div>                     <div class="overlay-secondary-container">                         <div class="edit-indicator-container"></div>                     </div>                     <div class="x-axis-row"></div>                     <div id="overlay-navbar-row" class="hidden-xs hidden-sm"></div>                 </div>             </div>         </div>     </div>',Q={},R=c||ia(Q),S={primary:void 0,secondaries:[],xAxis:qa.xAxis(),navbar:void 0,legend:qa.legend()},T=!1,U=b.util.render(d),V=!0;return Q.updateModel=function(a){a.call(this,R),T&&U()},Q.changeQuandlProduct=function(a){var b=ta.product(a,a,[R.periods.day1],R.sources.quandl,".3s"),c=R.headMenu.products.some(function(a){return a.id===b.id});c||R.headMenu.products.push(b),r(b),T&&U()},Q.run=function(b){var c=a.select(b);
// TODO: Could potentially use d3.html() to load the html from an external file
c.html(O);var d=c.select("#charts-container"),g=c.select("#overlay");F={app:c,charts:d,primary:d.select("#primary-container"),secondaries:d.selectAll(".secondary-container"),xAxis:d.select("#x-axis-container"),navbar:d.select("#navbar-container"),overlay:g,overlaySecondaries:g.selectAll(".overlay-secondary-container"),legend:c.select("#legend"),suspendLayout:function(a){var b=this;Object.keys(b).forEach(function(c){"function"!=typeof b[c]&&b[c].layoutSuspended(a)})}},S.primary=s(),S.navbar=t(),G=v(),J=w(),L=u(),M=z(),H=C(),N=E(),e(),f(),G(R.headMenu.selectedPeriod.seconds,R.headMenu.selectedProduct)},Q}a="default"in a?a["default"]:a,b="default"in b?b["default"]:b;var ka=0,la=!1,ma={centerOnDate:i,filterDataInDateRange:h,moveToLatest:g,padYDomain:f,trackingLatestData:e},na={domain:ma,layout:d,uid:c},oa={crosshairChange:"crosshairChange",viewChange:"viewChange",newTrade:"newTrade",historicDataLoaded:"historicDataLoaded",historicFeedError:"historicFeedError",streamingFeedError:"streamingFeedError",streamingFeedClose:"streamingFeedClose",dataProductChange:"dataProductChange",dataPeriodChange:"dataPeriodChange",resetToLatest:"resetToLatest",clearAllPrimaryChartIndicatorsAndSecondaryCharts:"clearAllPrimaryChartIndicatorsAndSecondaryCharts",primaryChartSeriesChange:"primaryChartSeriesChange",primaryChartYValueAccessorChange:"primaryChartYValueAccessorChange",primaryChartIndicatorChange:"primaryChartIndicatorChange",secondaryChartChange:"secondaryChartChange",indicatorChange:"indicatorChange",notificationClose:"notificationClose"},pa={base:k,macd:n,rsi:m,volume:l},qa={legend:w,nav:v,primary:u,xAxis:o,secondary:pa},ra={head:F,selectors:B,navigationReset:z,overlay:y},sa={toast:J},ta={period:N,product:M,source:L},ua={message:K,messages:Q},va={legend:W,nav:V,navigationReset:U,primary:T,secondary:S,xAxis:R},wa={head:$,periodAdaptor:D,productAdaptor:C,overlay:Z,dropdownConfig:Y,option:p,selector:X},xa={menu:wa,chart:va,data:ta,notification:ua},ya={app:ja};return ya});